<!DOCTYPE html>
<html>
    <head>
        <title>Charts using react</title>
        <!--import the libraries needed-->
        <link rel="stylesheet" href="styles.css">
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script src="https://d3js.org/d3-path.v2.min.js"></script>
        <script src="https://d3js.org/d3-shape.v2.min.js"></script>
        <script crossingin src="https://unpkg.com/react/umd/react.development.js"></script>
        <script crossingin src="https://unpkg.com/react-dom/umd/react-dom.development.js"></script>
        <script crossingin src="https://unpkg.com/babel-standalone/babel.js"></script>
    </head>
        
    <body>
      
        <h1> Company A & Company Y revenue graph by service</h1>
        <div id="root"></div>
        <script type='text/babel'>
            const margin = { top: 20, right:20, bottom: 180, left: 200, gap: 50 };
            const csvUrl = 'Revenue_sector2.csv'
            
            function useData(csvPath){
                const [dataAll, setData] = React.useState(null);
  
                React.useEffect(() => {
                    d3.csv(csvPath).then(data => {
                        data.forEach(d => {
                            d.id =+ d.id;
                            d.date = d.date;
                            d.year = + d.year;
                            d.revenue = + d.Revenue;
                            d.services= d.Services;
                            d.company = d.Company;
                        });
                        
                        setData(data);
                    });
                }, []);
                return dataAll;
            }

            function YAxes(props) {
               const {yScale,height2, height} = props;
               
               const ticks = yScale.ticks();
               
               return <g>
                <line y1 ={height} y2 = {height2} stroke = {`black`}/>
                {ticks.map( tickValue => {
                    return <g key ={tickValue} transform = {`translate(-5, ${yScale(tickValue)+height2})`}>
                                <line x1 = {-3} x2 = {5} stroke= {"black"}/>
                                <text transform = {`translate(-5, 3)`}style = {{textAnchor:'end',fontSize:'10px'}}>
                                    {tickValue}
                                </text>
                            </g> 
                            }
                        )
                }

                    <g transform = {`translate(20,10) rotate(-90)`}>
                        <text style = {{textAnchor:'end', fontSize: "12px"}}>
                            Revenue 
                        </text>
                    </g>

                  
                
                </g>
            }

            function XAxes(props) {
                const {xScale, width, height, data} = props;
    

                let domain = xScale.domain();

                if (typeof domain[0] == "string") {
                    const ticks = xScale.domain();

                    return <g>
                        <line x1={0} y1 ={height} x2 ={width} y2 ={height} stroke = {`black`} /> 
                        {ticks.map( tickValue => {  
                            return <g key = {tickValue} transform = {`translate(${xScale(tickValue)},${height})`}>
                                        <line y2 = {0} stroke = {"black"} />
                                        <g transform = {`translate(18,-5) rotate(60)`}>
                                            <text style = {{textAnchor:'start', fontSize: "10px"}} x={10} y = {25}>
                                            {tickValue}
                                            </text>
                                        </g>
                            </g>  
                                }
                            )
                        } 
                    </g>
                }
            }

           function Line_Con(props) {
            const {data,xScale,yScale,width,height} = props;
            console.log('work');
            const line1 = d3.line()
            .x(function(data) { return xScale(data.date + data.year); })
            .y(function(data) { return yScale(data.revenue); })
            
            return <g>
                <path d = {line1(data)} stroke="red" stroke-width="2" fill="none" />
            </g> 

           }

            function Points(props) {
                const {data,xScale,yScale,width, height,selectedPoint, setSelectedPoint} = props;
                
                const mouseOver = d => {
                    setSelectedPoint( d.id);
                };


                const mouseOut = () => {
                    setSelectedPoint(null);
                };

                const color = d => d.id == selectedPoint? "red":"steelblue";
                const radius = d => d.id  == selectedPoint? 10:5;
                
                if (selectedPoint == null) {
                    return <g>
                        {data.map(d => {
                            return  <circle key={d.id } cx={xScale(d.date+d.year)}
                                    cy = {yScale(d.revenue)} r ={5} fill= {'steelblue'} stroke={'black'} 
                                    onMouseOver= {()=> mouseOver(d)} onMouseOut = {mouseOut} /> 
                                })}
                    </g> 
                } else {



                    return <g>
                        {data.map(d => {
                            return  <circle key={d.id} cx={xScale(d.date+d.year)}
                                    cy = {yScale(d.revenue)} r ={radius(d)} fill= {color(d)} stroke={'black'} 
                                    onMouseOver= {()=> mouseOver(d)} onMouseOut = {mouseOut} />
                                })}

                        
                        {data.filter(d=> d.id  == selectedPoint).map (d=> {
                            return <g> 
                                    <circle key={d.id } cx={xScale(d.date+d.year)}
                                    cy = {yScale(d.revenue)} r ={radius(d)} fill= {color(d)} stroke={'black'} 
                                    onMouseOver= {()=> mouseOver(d)} onMouseOut = {mouseOut} />
                                    <Tooltip data = {data} xScale = {xScale} yScale = {yScale} width ={width} height={height} selectedPoint ={selectedPoint} setSelectedPoint={setSelectedPoint}/>
                                    </g>
                                
                        })}
                        </g>
                }
            }

            function ScatterPlot(props) {
                const {dataAll, data, HEIGHT, WIDTH, selectedPoint, setSelectedPoint} = props;
                if (!data) {return <pre>Loading...</pre>;}
               
                const height = HEIGHT/2;
                const width = WIDTH;
                const date  = [];
                
                dataAll.forEach(d => { if (d["date"] in date ) {} else { date.push( d["date"] + d["year"]) ;}})
                
                const xScale = d3.scaleBand().range([0,width])
                    .domain (date);
                console.log( d3.max(data,d => d.revenue));
                const yScale = d3.scaleLinear().range([height,0])
                    .domain([0, d3.max(data,d => d.revenue)]);
             
                return <g transform = {`translate(${margin.left}, ${margin.top})`} >
                    <Points data ={data} xScale ={xScale} yScale = {yScale}  width = {width} height = {height} selectedPoint ={selectedPoint} setSelectedPoint={setSelectedPoint}/>
                    <Line_Con data ={data}  xScale ={xScale} yScale = {yScale} width = {width} height = {height}/>
                    <YAxes  yScale ={yScale} height2 = {0} height = {height} />
                    <XAxes xScale ={xScale}  width = {width} height = {height} data = {data}/>
                </g>
            }

            function Tooltip(props) {
                
               const {data,xScale, yScale,width,height,selectedPoint, setSelectedPoint} = props;
               console.log("selectedPoint",selectedPoint);
               const Comp = {"Company_A": "Company A", "Company_B":"Company Y"}
               const mon = {"jan ":"January", "feb" :"February", "mar":"March", "apr":"April", "may":"May", "jun":"June", "jul":"July", "aug":"August", "sep":"September",  "oct":"October",  "nov":"November",  "dec":"December"};
               return <g>
                {data.filter(d=> d.id === selectedPoint).map (d=> {
                let shift = 0;
                if ((xScale(d.revenue)+155)> width) { 
                    shift = -170;
                }
                
                if (xScale(d.date+d.year)+170 < width && d.revenue>1000) {
                return <g transform = {`translate(${shift},0)`}> 
                    <rect x ={xScale(d.date+d.year)} y ={yScale(d.revenue)} rx={'15'} width = {170} height={100} fill='lime' opacity = {1}/>
                        <g transform = {`translate(${xScale(d.date+d.year)+5},${yScale(d.revenue)+20})`}>
                        <text style = {{textAnchor:'start', fontSize: "13px"}}>
                            Company: {Comp[d.company]}
                        </text>
                        </g>
                        <g transform = {`translate(${xScale(d.date+d.year)+10},${yScale(d.revenue)+40})`}>
                        <text style = {{textAnchor:'start', fontSize: "13px"}}>
                            Service: {d.services}
                        </text>
                        </g>
                        <circle cx={xScale(d.date+d.year)+16} cy={yScale(d.revenue)+55} r="2px"/>
                        <g transform = {`translate(${xScale(d.date+d.year)+23},${yScale(d.revenue)+60})`}>
                            <text style = {{textAnchor:'start', fontSize: "13px"}}>
                                Revenue: {d.revenue}
                            </text>
                        </g>
                        <circle cx={xScale(d.date+d.year)+16} cy={yScale(d.revenue)+75} r="2px"/>
                        <g transform = {`translate(${xScale(d.date+d.year)+23},${yScale(d.revenue)+80})`}>
                            <text style = {{textAnchor:'start', fontSize: "13px"}}>
                                Date: {mon[d.date] +" " +d.year}
                            </text>
                        </g>
                    </g>
                } 
                else if (yScale(d.revenue)>315) {
                    
                    return <g transform = {`translate(${shift},0)`}> 
                    <g transform = {`translate(0,-100)`}>    
                    <rect x ={xScale(d.date+d.year)} y ={yScale(d.revenue)} rx={'15'} width = {170} height={100} fill='lime' opacity = {1}/>
                        <g transform = {`translate(${xScale(d.date+d.year)+5},${yScale(d.revenue)+20})`}>
                        <text style = {{textAnchor:'start', fontSize: "13px"}}>
                            Company: {Comp[d.company]}
                        </text>
                        </g>
                        <g transform = {`translate(${xScale(d.date+d.year)+10},${yScale(d.revenue)+40})`}>
                        <text style = {{textAnchor:'start', fontSize: "13px"}}>
                            Service: {d.services}
                        </text>
                        </g>
                        <circle cx={xScale(d.date+d.year)+16} cy={yScale(d.revenue)+55} r="2px"/>
                        <g transform = {`translate(${xScale(d.date+d.year)+23},${yScale(d.revenue)+60})`}>
                            <text style = {{textAnchor:'start', fontSize: "13px"}}>
                                Revenue: {d.revenue}
                            </text>
                        </g>
                        <circle cx={xScale(d.date+d.year)+16} cy={yScale(d.revenue)+75} r="2px"/>
                        <g transform = {`translate(${xScale(d.date+d.year)+23},${yScale(d.revenue)+80})`}>
                            <text style = {{textAnchor:'start', fontSize: "13px"}}>
                                Date: {mon[d.date] +" " +d.year}
                            </text>
                        </g>
                    </g>
                    </g>



                }
                
                
                
                else {
                    return <g transform = {`translate(${shift},0)`}> 
                    <g transform = {`translate(-170,0)`}>    
                    <rect x ={xScale(d.date+d.year)} y ={yScale(d.revenue)} rx={'15'} width = {170} height={100} fill='lime' opacity = {1}/>
                        <g transform = {`translate(${xScale(d.date+d.year)+5},${yScale(d.revenue)+20})`}>
                        <text style = {{textAnchor:'start', fontSize: "13px"}}>
                            Company: {Comp[d.company]}
                        </text>
                        </g>
                        <g transform = {`translate(${xScale(d.date+d.year)+10},${yScale(d.revenue)+40})`}>
                        <text style = {{textAnchor:'start', fontSize: "13px"}}>
                            Service: {d.services}
                        </text>
                        </g>
                        <circle cx={xScale(d.date+d.year)+16} cy={yScale(d.revenue)+55} r="2px"/>
                        <g transform = {`translate(${xScale(d.date+d.year)+23},${yScale(d.revenue)+60})`}>
                            <text style = {{textAnchor:'start', fontSize: "13px"}}>
                                Revenue: {d.revenue}
                            </text>
                        </g>
                        <circle cx={xScale(d.date+d.year)+16} cy={yScale(d.revenue)+75} r="2px"/>
                        <g transform = {`translate(${xScale(d.date+d.year)+23},${yScale(d.revenue)+80})`}>
                            <text style = {{textAnchor:'start', fontSize: "13px"}}>
                                Date: {mon[d.date] +" " +d.year}
                            </text>
                        </g>
                    </g>
                    </g>
                }
                })}
                </g>
            }

            const Charts = () => {
                const dataAll = useData(csvUrl);
                const [selectedPoint, setSelectedPoint] = React.useState(null);
                const [categories, setCategories] = React.useState(0);
                
                if (!dataAll) {
                   return <pre>Loading...</pre>;
                };

                const WIDTH = 1200;
                const HEIGHT = 2000;
                const innerHeight = HEIGHT - margin.top - margin.bottom;
                const innerWidth = WIDTH - margin.left - margin.right; 
               
                const categoriesAll= ["Cleaning","Support_services","One_stop_services","security_services","Others","Subtotal","Total"];

                const mouseOut = () => {
                    setCategories(document.getElementById('slider').value);
                };
                console.log(dataAll);
                const data = dataAll.filter( d => { 
                    if (categoriesAll[categories] == 'Total') {
                        return d.company == "Company_B" && d.services == categoriesAll[categories];
                    }
                    if (categoriesAll[categories] =="Subtotal") {
                        return d.company == "Company_A" && d.services == "Subtotal ";
                    }
                    return d.company == "Company_A" && d.services == categoriesAll[categories]; 
                });
                
                const data2 = dataAll.filter( d => { 
                    if (categoriesAll[categories] == 'Others') {
                        return d.company == "Company_B" && d.services == 'Other';
                    }
                    return d.company == "Company_B" && d.services == categoriesAll[categories]; 
                });
              
              
           

                return (
                    <div>
                     
                        <div>
                            <input id="slider" type='range' min='0' max='6' step='1' value = {categories} onChange = {mouseOut}/>
                            <input id="monthText" type="int" value={categoriesAll[categories]} readOnly/>
                        </div>

                        <svg width={WIDTH} height={HEIGHT}>
                            <text transform = {`translate(720,15)`}style = {{textAnchor:'end',fontSize:'20px'}}>
                                    Company A Revenue {categoriesAll[categories]}
                            </text>
                            <ScatterPlot dataAll ={dataAll} data ={data} HEIGHT={innerHeight/2} WIDTH={innerWidth} selectedPoint ={selectedPoint} setSelectedPoint={setSelectedPoint}/>
                            <g transform = {`translate(0,600)`}>
                            <text transform = {`translate(720,15)`}style = {{textAnchor:'end',fontSize:'20px'}}>
                                    Company Y Revenue {categoriesAll[categories]}
                            </text>
                            <ScatterPlot dataAll ={dataAll} data ={data2} HEIGHT={innerHeight/2} WIDTH={innerWidth} selectedPoint ={selectedPoint} setSelectedPoint={setSelectedPoint}/>
                            </g>
                        </svg>
                    </div>
                )   
            }
            
           const rootElement = document.getElementById('root');
           ReactDOM.render(<Charts />, document.getElementById('root'));
        </script> 
    </body>
</html>